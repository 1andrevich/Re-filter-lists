name: Domains.lst and ip.lst Build Workflow

on:
  workflow_dispatch:

jobs:
  rkn_pipeline:
    runs-on: self-hosted
    timeout-minutes: 4800

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"


      - name: Create virtualenv
        run: |
          python3 -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip setuptools
          python -m pip install \
            "tqdm>=4.64.0" \
            "colorama>=0.4.4" \
            "requests>=2.28.0" \
            "aiohttp>=3.8.0" \
            "dnspython>=2.2.0" \
            "selenium>=4.11.0" \
            idna \
            geoip2 \
            counter \
            brotli \
            aiohttp_socks \
            undetected-chromedriver \
            "uvloop>=0.17.0"

      - name: Run Step 1 (download & word filter)
        run: |
          set -euo pipefail
          ulimit -n 65535
          . ../.venv/bin/activate
          python step1-download-and-word-filter.py
        working-directory: src

      - name: Run Reprioritize Domains
        run: |
          set -euo pipefail
          ulimit -n 65535
          . ../.venv/bin/activate
          python reprioritize_domains.py --file=domains_new_1.lst --output=domains_new_1.lst
        working-directory: src

      - name: Run Step 2 (availability check)
        run: |
          set -euo pipefail
          ulimit -n 65535
          . ../.venv/bin/activate
          python step2-availability-check.py
        working-directory: src

      - name: Write proxies from secret
        env:
          RKN_PROXIES: ${{ secrets.PROXIES }}
        run: |
          if [ -z "${RKN_PROXIES}" ]; then
            echo "RKN_PROXIES secret is empty" >&2
            exit 1
          fi
          printf '%s\n' "${RKN_PROXIES}" > src/proxies.txt

      - name: Run Step 3 (content check)
        run: |
          set -euo pipefail
          ulimit -n 65535
          . ../.venv/bin/activate
          python step3-content-check.py
        working-directory: src

      - name: Run Step 4 (domain resolver)
        run: |
          set -euo pipefail
          ulimit -n 65535
          . ../.venv/bin/activate
          python step4-domain-resolver.py
        working-directory: src

      - name: Move outputs to sum/input/
        run: |
          mkdir -p sum/input
          if [ -f src/domains.lst ]; then
            mv src/domains.lst sum/input/domains.lst
          else
            echo "domains.lst not found" >&2
            exit 1
          fi
          if [ -f src/ip.lst ]; then
            mv src/ip.lst sum/input/ip.lst
          else
            echo "ip.lst not found" >&2
            exit 1
          fi

      - name: Remove proxies file
        run: rm -f src/proxies.txt

      - name: Set PR date
        run: |
          DATE_TAG=$(date +%d%m%Y)
          DATE_TITLE=$(date +%d-%m-%Y)
          echo "DATE_TAG=${DATE_TAG}" >> $GITHUB_ENV
          echo "DATE_TITLE=${DATE_TITLE}" >> $GITHUB_ENV


      - name: Upload build results
        uses: actions/upload-artifact@v4
        with:
          name: build_results
          path: |
            .
            !proxies.txt

  create_pr:
    needs: rkn_pipeline
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          path: repo
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure GitHub token is used for git operations
        run: |
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Copy input files into repo
        run: |
          SRC_DIR=/home/github/actions-runner/_work/Re-filter-lists/Re-filter-lists/sum/input
          test -f "${SRC_DIR}/domains.lst"
          test -f "${SRC_DIR}/ip.lst"
          mkdir -p repo/sum/input
          cp "${SRC_DIR}/domains.lst" repo/sum/input/domains.lst
          cp "${SRC_DIR}/ip.lst" repo/sum/input/ip.lst

      - name: Set PR date
        run: |
          DATE_TAG=$(date +%d%m%Y)
          DATE_TITLE=$(date +%d-%m-%Y)
          echo "DATE_TAG=${DATE_TAG}" >> $GITHUB_ENV
          echo "DATE_TITLE=${DATE_TITLE}" >> $GITHUB_ENV

      - name: Create PR to main with outputs
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: auto-build-${{ env.DATE_TAG }}
          commit-message: "Update domains.lst and ip.lst"
          title: "Update outputs ${{ env.DATE_TITLE }}"
          body: "Automated update of domains.lst and ip.lst."
          add-paths: |
            sum/input/domains.lst
            sum/input/ip.lst
          path: repo

      - name: Cleanup git url rewrite
        if: always()
        run: |
          git config --global --unset-all url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf || true
          git config --local --unset-all http.https://github.com/.extraheader || true
