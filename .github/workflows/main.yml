name: Domains.lst and ip.lst Build Workflow

on:
  workflow_dispatch:
jobs:
  rkn_pipeline:
    runs-on: self-hosted
    timeout-minutes: 4800

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo install -d /etc/apt/keyrings
          curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /etc/apt/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential python3-dev python3-pip python3-venv \
            curl wget git unzip ca-certificates gnupg lsb-release \
            google-chrome-stable \
            libssl-dev libffi-dev libxml2-dev libxslt1-dev libjpeg-dev libpng-dev \
            zlib1g-dev libncurses5-dev libreadline-dev libsqlite3-dev libgdbm-dev \
            libdb5.3-dev libbz2-dev libexpat1-dev liblzma-dev tk-dev libc6-dev

      - name: Create virtualenv
        run: |
          python3 -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip setuptools
          python -m pip install \
            "tqdm>=4.64.0" \
            "colorama>=0.4.4" \
            "requests>=2.28.0" \
            "aiohttp>=3.8.0" \
            "dnspython>=2.2.0" \
            "selenium>=4.11.0" \
            idna \
            geoip2 \
            counter \
            brotli \
            aiohttp_socks \
            undetected-chromedriver \
            "uvloop>=0.17.0"

      - name: Run Step 1 (download & word filter)
        run: |
          set -euo pipefail
          ulimit -n 65535
          . .venv/bin/activate
          python src/step1-download-and-word-filter.py

      - name: Run Reprioritize Domains
        run: |
          set -euo pipefail
          ulimit -n 65535
          . .venv/bin/activate
          python src/reprioritize_domains.py --file=domains_new_1.lst --output=domains_new_1.lst

      - name: Run Step 2 (availability check)
        run: |
          set -euo pipefail
          ulimit -n 65535
          . .venv/bin/activate
          python src/step2-availability-check.py

      - name: Write proxies from secret
        env:
          RKN_PROXIES: ${{ secrets.PROXIES }}
        run: |
          if [ -z "${RKN_PROXIES}" ]; then
            echo "RKN_PROXIES secret is empty" >&2
            exit 1
          fi
          printf '%s\n' "${RKN_PROXIES}" > proxies.txt

      - name: Run Step 3 (content check)
        run: |
          set -euo pipefail
          ulimit -n 65535
          . .venv/bin/activate
          python src/step3-content-check.py

      - name: Remove proxies file
        run: rm -f proxies.txt

      - name: Run Step 4 (domain resolver)
        run: |
          set -euo pipefail
          ulimit -n 65535
          . .venv/bin/activate
          python src/step4-domain-resolver.py

      - name: Move outputs to sum/input/
        run: |
          mkdir -p sum/input
          if [ -f domains.lst ]; then
            mv domains.lst sum/input/domains.lst
          else
            echo "domains.lst not found" >&2
            exit 1
          fi
          if [ -f ip.lst ]; then
            mv ip.lst sum/input/ip.lst
          else
            echo "ip.lst not found" >&2
            exit 1
          fi

      - name: Set PR date
        run: |
          DATE_TAG=$(date +%d%m%Y)
          DATE_TITLE=$(date +%d-%m-%Y)
          echo "DATE_TAG=${DATE_TAG}" >> $GITHUB_ENV
          echo "DATE_TITLE=${DATE_TITLE}" >> $GITHUB_ENV

      - name: Create PR to beta with outputs
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: beta
          branch: rkn-output-${{ env.DATE_TAG }}
          commit-message: "Update domains.lst and ip.lst"
          title: "Update outputs ${{ env.DATE_TITLE }}"
          body: "Automated update of domains.lst and ip.lst."
          add-paths: |
            sum/input/domains.lst
            sum/input/ip.lst

      - name: Upload build results
        uses: actions/upload-artifact@v4
        with:
          name: build_results
          path: |
            .
            !proxies.txt
